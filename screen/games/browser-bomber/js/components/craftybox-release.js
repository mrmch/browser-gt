(function(){var a,k,c,n,b,j,g,d,p,e,m,o,l,i,h,f;m=Box2D.Common.Math.b2Vec2;i=Box2D.Dynamics,c=i.b2BodyDef,k=i.b2Body,d=i.b2FixtureDef,g=i.b2Fixture,o=i.b2World,j=i.b2DebugDraw,b=i.b2ContactListener;h=Box2D.Collision,a=h.b2AABB,l=h.b2WorldManifold,(f=h.Shapes,p=f.b2MassData,e=f.b2PolygonShape,n=f.b2CircleShape);Crafty.extend({Box2D:(function(){var s,t,r,u,q;s=30;q=null;u=[];t=function(){var v;v=new b;v.BeginContact=function(z){var C,B,A,w;B=z.GetFixtureA().GetBody().GetUserData();A=z.GetFixtureB().GetBody().GetUserData();w=new l();z.GetWorldManifold(w);C=w.m_points;Crafty(B).trigger("BeginContact",{points:C,targetId:A});return Crafty(A).trigger("BeginContact",{points:C,targetId:B})};v.EndContact=function(w){var A,z;A=w.GetFixtureA().GetBody().GetUserData();z=w.GetFixtureB().GetBody().GetUserData();Crafty(A).trigger("EndContact");return Crafty(z).trigger("EndContact")};return q.SetContactListener(v)};r=function(){var v,w;if(Crafty.support.canvas){v=document.createElement("canvas");v.id="Box2DCanvasDebug";v.width=Crafty.viewport.width;v.height=Crafty.viewport.height;v.style.position="absolute";v.style.left="0px";v.style.top="0px";Crafty.stage.elem.appendChild(v);w=new j();w.SetSprite(v.getContext("2d"));w.SetDrawScale(s);w.SetFillAlpha(0.7);w.SetLineThickness(1);w.SetFlags(j.e_shapeBit|j.e_joinBit);return q.SetDebugDraw(w)}};return{debug:false,init:function(v){var D,z,w,B,A,C=this;A=v!=null?v:{},z=A.gravityX,w=A.gravityY,B=A.scale,D=A.doSleep;z=z!=null?z:0;w=w!=null?w:0;s=B!=null?B:30;D=D!=null?D:true;q=new o(new m(z,w),D);this.__defineGetter__("world",function(){return q});this.__defineSetter__("gravity",function(G){var E,F;q.SetGravity(new m(G.x,G.y));E=q.GetBodyList();F=[];while(E!=null){E.SetAwake(true);F.push(E=E.GetNext())}return F});this.__defineGetter__("gravity",function(){return q.GetGravity()});this.__defineGetter__("SCALE",function(){return s});t();Crafty.bind("EnterFrame",function(){var E,G,F;q.Step(1/Crafty.timer.getFPS(),10,10);for(G=0,F=u.length;G<F;G++){E=u[G];q.DestroyBody(E)}u=[];if(C.debug){q.DrawDebugData()}return q.ClearForces()});return r()},destroy:function(v){var w;if(v!=null){return u.push(v)}else{v=q.GetBodyList();w=[];while(v!=null){u.push(v);w.push(v=v.GetNext())}return w}}}})()});Crafty.c("Box2D",(function(){var t,q,s,r,u;s=null;q=function(B){var K,C,J,D,E,A,v,z,F,I,H,G;H=B.x,G=B.y,I=B.w,E=B.h,v=B.r,A=B.poly,F=B.type,J=B.density,D=B.friction,z=B.restitution;K=Crafty.Box2D.SCALE;C=new c;if((F!=null)&&(F==="static"||F==="dynamic"||F==="kinematic")){C.type=k["b2_"+F+"Body"]}C.position.Set(H/K,G/K);this.body=Crafty.Box2D.world.CreateBody(C);this.body.SetUserData(this[0]);s=s!=null?s:new d;s.density=J!=null?J:1;s.friction=D!=null?D:0.5;s.restitution=z!=null?z:0.2;if(v!=null){return t.call(this,v)}else{if((I!=null)||(E!=null)){I=I!=null?I:E;E=E!=null?E:I;return u.call(this,I,E)}else{if(A!=null){return r.call(this,A)}}}};t=function(v){var z,w;if(!this.x||!this.y){return}z=Crafty.Box2D.SCALE;if(!this.body){w=new c;w.position.Set(x/z,y/z);this.body=Crafty.Box2D.world.CreateBody(w)}this._w=this._h=v*2;s.shape=new n(v/z);s.shape.SetLocalPosition(new m(this.w/z/2,this.h/z/2));this.body.CreateFixture(s);return this};u=function(v,A){var B,z;this.w=v;this.h=A;if(!this.x||!this.y){return}B=Crafty.Box2D.SCALE;if(!this.body){z=new c;z.position.Set(x/B,y/B);this.body=Crafty.Box2D.world.CreateBody(z)}s.shape=new e;s.shape.SetAsOrientedBox(v/2/B,A/2/B,new m(v/2/B,A/2/B));this.body.CreateFixture(s);return this};r=function(w){var C,v,B,A,z;if(!this.x||!this.y){return}C=Crafty.Box2D.SCALE;if(!this.body){v=new c;v.position.Set(x/C,y/C);this.body=Crafty.Box2D.world.CreateBody(v)}if(arguments.length>1){w=Array.prototype.slice.call(arguments,0)}C=Crafty.Box2D.SCALE;s.shape=new e;B=function(E){var D;return D=new m(E[0]/C,E[1]/C)};A=(function(){var F,E,D;D=[];for(F=0,E=w.length;F<E;F++){z=w[F];D.push(B(z))}return D})();s.shape.SetAsArray((function(){var F,E,D;D=[];for(F=0,E=w.length;F<E;F++){z=w[F];D.push(B(z))}return D})(),w.length);this.body.CreateFixture(s);return this};return{body:null,init:function(){var v,w=this;this.addComponent("2D");if(!(Crafty.Box2D.world!=null)){Crafty.Box2D.init()}v=Crafty.Box2D.SCALE;this.bind("Change",function(z){if(!(z!=null)){return}if((z.x!=null)&&(z.y!=null)){return q.call(w,z)}});this.bind("Move",function(z){var D,C,B,A;B=z._x,A=z._y,C=z._w,D=z._h;if(!(w.body!=null)||(w.body.GetType()===k.b2_dynamicBody&&w.body.IsAwake())){return}if(B!==w.x||A!==w.y){w.body.SetPosition(new m(w.x/v,w.y/v))}if(C!==w.w||D!==w.h){if(w.body.GetFixtureList()!=null){w.body.DestroyFixture(w.body.GetFixtureList())}if(!(w.r!=null)){return u.call(w,w.w,w.h)}else{w.r=w.w<w.h?w.w/2:w.h/2;return t.call(w,w.r)}}});this.bind("EnterFrame",function(){var z,A;if((w.body!=null)&&w.body.IsAwake()){A=w.body.GetPosition();z=Crafty.math.radToDeg(w.body.GetAngle());if(A.x*v!==w.x){w.x=A.x*v}if(A.y*v!==w.y){w.y=A.y*v}if(z!==w.rotation){return w.rotation=z}}});return this.bind("Remove",function(){if(w.body!=null){return Crafty.Box2D.destroy(w.body)}})},circle:function(v){return t.call(this,v)},rectangle:function(v,z){return u.call(this,v,z)},polygon:function(v){return r.call(this,v)},hit:function(B){var z,D,A,w,C,v;z=this.body.GetContactList();if(!(z!=null)){return false}v=z.other.GetUserData();C=Crafty(v);if(!C.has(B)){return false}if(!z.contact.IsTouching()){return false}A=[];w=new l();z.contact.GetWorldManifold(w);D=w.m_points;A.push({obj:C,type:"Box2D",points:D});return A},onHit:function(w,z,v){var A=this;if(w!=="Box2D"){return this}this.bind("BeginContact",function(C){var B;B=[{obj:Crafty(C.targetId),type:"Box2D",points:C.points}];return z.call(A,B)});if(typeof v==="function"){this.bind("EndContact",function(){return v.call(A)})}return this}}})())}).call(this);