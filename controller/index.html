<!DOCTYPE html>
<!-- Conditional comment for mobile ie7 blogs.msdn.com/b/iemobile/ -->
<!--[if IEMobile 7 ]>    <html class="no-js iem7" lang="en"> <![endif]-->
<!--[if (gt IEMobile 7)|!(IEMobile)]><!--> <html class="no-js" lang="en"> <!--<![endif]-->

<head>
  <meta charset="utf-8">

  <title>Game Controller</title>
  <meta name="description" content="">

  <!-- Mobile viewport optimization h5bp.com/ad -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width">

  <!-- For iPhone 4 with high-resolution Retina display: -->
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="img/h/apple-touch-icon.png">
  <!-- For first-generation iPad: -->
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="img/m/apple-touch-icon.png">
  <!-- For non-Retina iPhone, iPod Touch, and Android 2.1+ devices: -->
  <link rel="apple-touch-icon-precomposed" href="img/l/apple-touch-icon-precomposed.png">
  <!-- For nokia devices: -->
  <link rel="shortcut icon" href="img/l/apple-touch-icon.png">

  <!-- iOS web app, delete if not needed. https://github.com/h5bp/mobile-boilerplate/issues/94 -->
  <!-- <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black"> -->
  <!-- <script>(function(){var a;if(navigator.platform==="iPad"){a=window.orientation!==90||window.orientation===-90?"img/startup-tablet-landscape.png":"img/startup-tablet-portrait.png"}else{a=window.devicePixelRatio===2?"img/startup-retina.png":"img/startup.png"}document.write('<link rel="apple-touch-startup-image" href="'+a+'"/>')})()</script> -->
  
  <!-- The script prevents links from opening in mobile safari. https://gist.github.com/1042026 -->
  <!-- <script>(function(a,b,c){if(c in b&&b[c]){var d,e=a.location,f=/^(a|html)$/i;a.addEventListener("click",function(a){d=a.target;while(!f.test(d.nodeName))d=d.parentNode;"href"in d&&(d.href.indexOf("http")||~d.href.indexOf(e.host))&&(a.preventDefault(),e.href=d.href)},!1)}})(document,window.navigator,"standalone")</script> -->
  
  <meta http-equiv="cleartype" content="on">
  <link rel="stylesheet" href="/controller/css/style.css">

  <script src="/controller/js/libs/modernizr-2.0.6.min.js"></script>
</head>

<body>

  <div id="container">
    <header>

    </header>
    
    <div id="main" role="main">
      <div id="debug"></div>
      <ul id="screens"></ul>
    </div>

    <footer>

    </footer>
  </div>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="/controller/js/libs/jquery-1.7.1.min.js"><\/script>')</script>

  <script src="/controller/js/helper.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  
  <!-- Controller logic -->
  <script>
    var socket = io.connect(window.location.origin),
        controller = {
          id: Math.round(Math.random() * 1000000000)
        },
        screens = [],
        inGame = false,
        debug = function (msg) {
          $("#debug").html(msg);
        },
        
        // emit is throttled to a max of emitRateMax emits per second
        emitRateMax = 100, emitCounter = 0, emitRateCounterReset = 500,
        
        emitIsThrottled = function () {
          if (emitCounter > emitRateMax) {
            return true;
          }
          return false;
        };
        
    window.setInterval(function() {
      emitCounter = 0;
    }, emitRateCounterReset);
      
    socket.on('updated screen list', function(updated_screens) {
      screens = updated_screens;
      debug("Total screens: " + screens.length);
      console.log(screens);
      
      $("#screens").html("");
      for (var i in screens) {
        $("ul#screens").append($("<li>click to join: <a href='' class='joinScreen' id='" + screens[i] + "'>" + screens[i] + "</a></li>"));
      }
    });
    
    socket.on('connect', function() {
      socket.emit('set controller_id', controller.id);
    });
        
    socket.on('disconnect', function() {
      debug("Error connecting to the server.");
      inGame = false;
    });
    
    var tilt = function(o) {
      if (!inGame || emitIsThrottled()) {
        return;
      }
      
      emitCounter += 1;
      socket.emit('action', {'accelerometer': o});
      debug("Acc: " + o[0] + " : " + o[1]);
    };
    
    if (window.DeviceOrientationEvent) {
        window.addEventListener("deviceorientation", function () {
            tilt([event.beta, event.gamma]);
        }, true);
    } else if (window.DeviceMotionEvent) {
        window.addEventListener('devicemotion', function () {
            tilt([event.acceleration.x * 2, event.acceleration.y * 2]);
        }, true);
    } else {
        window.addEventListener("MozOrientation", function () {
            tilt([orientation.x * 50, orientation.y * 50]);
        }, true);
    }
    
    $(function() {
      $(".joinScreen").live('click', function() {
        var screen_id = $(this).attr("id");
        
        socket.emit("join screen", screen_id);
        inGame = true;
        
        $("ul#screens").hide();
        debug("Joined screen");
        
        return false;
      });
    });
    
  </script>
</body>
</html>