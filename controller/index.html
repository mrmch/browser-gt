<!DOCTYPE html>
<!-- Conditional comment for mobile ie7 blogs.msdn.com/b/iemobile/ -->
<!--[if IEMobile 7 ]>    <html class="no-js iem7" lang="en"> <![endif]-->
<!--[if (gt IEMobile 7)|!(IEMobile)]><!--> <html class="no-js" lang="en"> <!--<![endif]-->

    <head>
        <meta charset="utf-8">

        <title>Game Controller</title>
        <meta name="description" content="">

        <!-- Mobile viewport optimization h5bp.com/ad -->
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="viewport" content="width=device-width">

        <!-- For iPhone 4 with high-resolution Retina display: -->
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="img/h/apple-touch-icon.png">
        <!-- For first-generation iPad: -->
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="img/m/apple-touch-icon.png">
        <!-- For non-Retina iPhone, iPod Touch, and Android 2.1+ devices: -->
        <link rel="apple-touch-icon-precomposed" href="img/l/apple-touch-icon-precomposed.png">
        <!-- For nokia devices: -->
        <link rel="shortcut icon" href="img/l/apple-touch-icon.png">

        <!-- iOS web app, delete if not needed. https://github.com/h5bp/mobile-boilerplate/issues/94 -->
        <!-- <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black"> -->
        <!-- <script>(function(){var a;if(navigator.platform==="iPad"){a=window.orientation!==90||window.orientation===-90?"img/startup-tablet-landscape.png":"img/startup-tablet-portrait.png"}else{a=window.devicePixelRatio===2?"img/startup-retina.png":"img/startup.png"}document.write('<link rel="apple-touch-startup-image" href="'+a+'"/>')})()</script> -->

        <!-- The script prevents links from opening in mobile safari. https://gist.github.com/1042026 -->
        <!-- <script>(function(a,b,c){if(c in b&&b[c]){var d,e=a.location,f=/^(a|html)$/i;a.addEventListener("click",function(a){d=a.target;while(!f.test(d.nodeName))d=d.parentNode;"href"in d&&(d.href.indexOf("http")||~d.href.indexOf(e.host))&&(a.preventDefault(),e.href=d.href)},!1)}})(document,window.navigator,"standalone")</script> -->

        <meta http-equiv="cleartype" content="on">
        <link rel="stylesheet" href="/controller/css/style.css">

        <script src="/controller/js/libs/modernizr-2.0.6.min.js"></script>
    </head>

    <body>

        <div id="container">
            <header>

            </header>
            
            <div id="main" role="main">
                <div id="debug"></div>
                <ul id="screens"></ul>
                <div id="controller"></div>
            </div>

            <footer>

            </footer>
        </div>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="/controller/js/libs/jquery-1.7.1.min.js"><\/script>')</script>

        <script src="/controller/js/helper.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        
        <script>
        
            // --- controller API ---
            
            var Controller = {
                id: Math.round(Math.random() * 1000000000),
                socket: io.connect(window.location.origin + "/controllers"),
                
                screens: [],
                
                screen: {
                    id: 0,
                    
                    join: function(screen_id) {
                        Controller.socket.emit("join screen", screen_id);
                        Controller.screen.id = screen_id;
                    },
                    
                    leave: function() {
                        if (Controller.screen.id) {
                            Controller.screen.id = 0;
                        }
                    }
                },
            
                emit: {
                    rate_max: 30,
                    counter: 0,
                    reset_rate: 500,
                    
                    resetCounter: function() {
                        Controller.emit.counter = 0;
                    },
                    
                    isThrottled: function () {
                        if (Controller.emit.counter > Controller.emit.rate_max) {
                            return true;
                        }
                        return false;
                    }
                },
                
                util: {
                    debug: function (msg) {
                        $("#debug").html(msg);
                    }
                },
                
                system: {
                    emit_reset_id: 0,
                    
                    init: function() {
                        Controller.system.emit_reset_id = window.setInterval('Controller.emit.resetCounter()', Controller.emit.reset_rate);
                    },
                    
                    disconnected: function() {
                        Controller.screen.leave();
                    }
                },
                
                actions: {
                    tilt: function(o) {
                        if (!Controller.screen.id || Controller.emit.isThrottled()) {
                            return;
                        }

                        Controller.emit.counter += 1;
                        Controller.socket.emit('action', {'accelerometer': o});

                        Controller.util.debug("Acc: " + o[0] + " : " + o[1]);
                    },

                    button: function(o) {
                        if (!Controller.screen.id || Controller.emit.isThrottled()) {
                            return;
                        }

                        Controller.emit.counter += 1;
                        Controller.util.debug("Button: " + o.action + " : " + o.state);
                        Controller.socket.emit('action', {'button': o});

                    },

                },
                
                ui: {
                    updateScreenList: function() {
                        $("ul#screens").show();
                        $("ul#screens").html("");

                        for (var i in Controller.screens) {
                            $("ul#screens").append($("<li>click to join: <a href='' class='joinScreen' id='" + Controller.screens[i] + "'>" + Controller.screens[i] + "</a></li>"));
                        }
                    },
                    
                    joinedScreen: function() {
                        $("ul#screens").hide();
                        Controller.util.debug("Joined screen " + Controller.screen.id);
                    }
                }
            };
                
            Controller.system.init();
                
                
            // --- network code ---
                    
            Controller.socket.on('updated screen list', function(updated_screens) {
                if (updated_screens.length == 0 && Controller.screen.id) {
                    Controller.screen.leave();
                }
                
                Controller.screens = updated_screens;
                Controller.util.debug("Total screens: " + Controller.screens.length);
                
                Controller.ui.updateScreenList();
            });
            
            Controller.socket.on('connect', function() {
                Controller.socket.emit('set controller_id', Controller.id);
            });
                
            Controller.socket.on('disconnect', function() {
                Controller.util.debug("Error connecting to the server.");
                Controller.system.disconnected();
            });
            
            
            // --- sensors ---
            /*
                
            if (window.DeviceOrientationEvent) {
                window.addEventListener("deviceorientation", function () {
                    Controller.actions.tilt([event.beta, event.gamma]);
                }, true);
            } else if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', function () {
                    Controller.actions.tilt([event.acceleration.x * 2, event.acceleration.y * 2]);
                }, true);
            } else {
                window.addEventListener("MozOrientation", function () {
                    Controller.actions.tilt([orientation.x * 50, orientation.y * 50]);
                }, true);
            }
            */

            var gc;
            var bs = 60; // BOX SIZE CONSTANT

            var default_controllers = {
                dpad: function(opts) {
                    opts.x = opts.x || 0;
                    opts.y = opts.y || 0;
                    opts.w = opts.w || 60;
                    opts.h = opts.h || 60;
                    opts.padding = opts.padding || 0;

                    var buttons = [{
                            x: opts.x + opts.w, 
                            y: opts.y, 
                            w: opts.w,
                            h: opts.h,
                            action: 'UP',
                            bounds: ['top', 'left']
                        }, {
                            x: opts.x, 
                            y: opts.y + opts.w, 
                            w: opts.w,
                            h: opts.h,
                            action: 'LEFT',
                            bounds: ['top', 'left']
                        },  {
                            x: opts.x + (opts.w* 2), 
                            y: opts.y + opts.h, 
                            w: opts.w,
                            h: opts.h,
                            action: 'RIGHT',
                            bounds: ['top', 'left']
                        }, {
                            x: opts.x + opts.w, 
                            y: opts.y + (opts.h* 2), 
                            w: opts.w,
                            h: opts.h,
                            action: 'DOWN',
                            bounds: ['top', 'left']
                        }
                    ]; 

                    return buttons;
                },

                twoButtons: function(opts) {
                    opts.x = opts.x || 0;
                    opts.y = opts.y || 0;
                    opts.w = opts.w || 80;
                    opts.h = opts.h || 80;
                    opts.padding = opts.padding || 20;

                    var buttons = [{
                            x: opts.x + opts.padding + (opts.w * 2), 
                            y: opts.y + opts.h, 
                            w: opts.w, 
                            h: opts.h, 
                            action: 'BUTTON_A',
                            fill: '#33FF00',
                            fireOnce: true,
                            bounds: ['top', 'right']
                        }, {
                            x: opts.x + opts.w, 
                            y: opts.y + opts.h, 
                            w: opts.w, 
                            h: opts.h, 
                            action: 'BUTTON_B',
                            fill: '#33FF00',
                            fireOnce: true,
                            bounds: ['top', 'right']
                        }
                    ];
                    return buttons; 
                }
            };
            
            function Control(opts) {
                console.log('creating control', opts);
                this.x = opts.x || 0;
                this.y = opts.y || 0;
                this.w = opts.w || bs;
                this.h = opts.h || bs;
                this.fill = opts.fill || '#FF6600';
                this.type = opts.type || 'button';
                this.action = opts.action || '';
                this.fireOnce = opts.fireOnce || false;
                this.state = opts.state || 'up';
                this.bounds = opts.bounds || ['top', 'left'];
            };

            Control.prototype.render = function(opts) {
                var controlId = opts.controlId || null;

                var el = document.createElement('div');
                $(el)
                    .attr('id', this.action)
                    .data('controlId', parseInt(controlId)) 
                    .css({
                        position: 'absolute',
                        width: this.w,
                        height: this.h,
                        background: this.fill
                    })
                    .css(this.bounds[0], this.y)
                    .css(this.bounds[1], this.x);
                this.el = el;
                return el;
            };

            Control.prototype.fireEvent = function(e) {
                e.preventDefault();

                if (this.fireOnce) {
                    Controller.actions.button(this);
                } else if (e.type == "mousedown") {
                    $(this.el).bind('mouseleave', GCEventHandler.fireEvent);
                    this.fireMouseDown(); 
                } else if (e.type == "mouseup") {
                    this.fireMouseUp();
                } else if (e.type == "mouseleave") {
                    this.fireMouseUp();
                }
            };

            Control.prototype.fireMouseDown = function() {
                console.log('fireMouseDown', this);
                this.state = 'down';
                var me = this;
                clearInterval(this.interval);
                this.interval = setInterval(function() {me.fireMouseDown();}, 500);
                Controller.actions.button(this);
            };

            Control.prototype.fireMouseUp = function() {
                console.log('fireMouseUp', this);
                clearInterval(this.interval);
                $(this.el).unbind('mouseleave');
            };

            var GCEventHandler = {
                fireEvent: function(e) {
                    var controlId = parseInt($(this).data('controlId')) || 0;
                    gc.controls[controlId].fireEvent(e);
                }
            };

            function GameController (opts) {
                // constructor
                this.controls = [];
            };

            GameController.prototype.init = function(opts) {
                this.container = opts.container || '#controller';
                this.container = $(this.container);

                var dpad = default_controllers.dpad({
                    x: 0,
                    y: 0
                });

                var two_buttons = default_controllers.twoButtons({
                    x: 0,
                    y: 0
                });


                for (i = 0; i < dpad.length; i++)
                    this.controls.push(new Control(dpad[i]));


                for (i = 0; i < two_buttons.length; i++)
                    this.controls.push(new Control(two_buttons[i]));

                for (i = 0; i < this.controls.length; i++) {
                    this.container.append(this.controls[i].render({controlId:i}));
                }

                var listen_events = "mousedown mouseup touchstart touchend"
                this.container.on(listen_events, 'div', GCEventHandler.fireEvent);
            };
            
            // --- ui interactions ---
            
            $(function() {
                $(".joinScreen").live('click', function() {
                    Controller.screen.join($(this).attr("id"));
                    Controller.ui.joinedScreen();

                    gc = new GameController({});
                    gc.init({});
                    
                    return false;
                });

            });

            
        </script>
    </body>
</html>

